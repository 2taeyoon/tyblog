## ğŸ¦® NextAuthì™€ MongoDB ì—°ê²°í•˜ê¸°

Next.js 13ì—ì„œ êµ¬ê¸€ ë¡œê·¸ì¸ êµ¬í˜„í•˜ê³  ì‹¶ë‹¤êµ¬ìš”? `next-auth`ë§Œ ìˆìœ¼ë©´ ë¡œê·¸ì¸ë¶€í„° DB ì €ì¥, ì„¸ì…˜ ê´€ë¦¬ê¹Œì§€ ì „ë¶€ ë‹¤ ë©ë‹ˆë‹¤.  
ê²Œë‹¤ê°€ **MongoDBAdapter ì—†ì´**? ì»¤ìŠ¤í…€í•´ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤!

---

## ğŸ¤” ì™œ MongoDBAdapter ì•ˆ ì¼ëƒê³ ìš”?

> MongoDBAdapterëŠ” ì¢‹ê¸´ í•œë° **ì œ í”„ë¡œì íŠ¸ì— í•„ìš”í•œ ë°ì´í„° êµ¬ì¡°ê°€ ë…íŠ¹**í–ˆì–´ìš”.

- ê²Œì„ ë°ì´í„° êµ¬ì¡° (`gameData.level`, `kodleGameWins` ë“±) ì´ˆê¸°ê°’ ì„¤ì •ì´ í•„ìš”í–ˆìŒ.
- ì‚¬ìš©ì ìƒì„± ì‹œ ì»¤ìŠ¤í…€ í•„ë“œë¥¼ ì§ì ‘ ì œì–´í•˜ê³  ì‹¶ì—ˆìŒ.
- `MongoDBAdapter` ì“°ë©´ ìë™ìœ¼ë¡œ `_id`, `emailVerified`, `email` ê°™ì€ í•„ë“œë§Œ ë“¤ì–´ê°€ê³  ì»¤ìŠ¤í…€ ë°ì´í„° ì‚½ì…ì´ ë¶ˆí¸í–ˆìŒ.

ê·¸ë˜ì„œ ì–´ëŒ‘í„° ëŒ€ì‹  **ì§ì ‘ MongoDBì— ì‚¬ìš©ì ë°ì´í„°ë¥¼ ì €ì¥í•˜ëŠ” ë°©ì‹**ì„ íƒí–ˆì–´ìš”.  
ì´ëŸ¬ë©´ ë‚´ê°€ ì›í•˜ëŠ” êµ¬ì¡°ë¡œ DBì— ë„£ì„ ìˆ˜ ìˆê³ , í™•ì¥ë„ ììœ ë¡­ê¸° ë•Œë¬¸ì´ì£  ã…ã…ã…..? ë§ë‚˜?

---

## ğŸ¦® í”„ë¡œì íŠ¸ êµ¬ì¡° ê°œìš”

| íŒŒì¼ | ì—­í•  |
|------|------|
| `src/app/api/auth/[...nextauth]/route.ts` | ë¡œê·¸ì¸ ì¸ì¦ ë¡œì§ ë‹¤ ë“¤ì–´ìˆëŠ” í•µì‹¬ íŒŒì¼ |
| `src/lib/mongodb.ts` | MongoDB ì—°ê²° í´ë¼ì´ì–¸íŠ¸ |
| `src/app/auth/Auth.tsx` | ë¡œê·¸ì¸ UI í˜ì´ì§€ ì»´í¬ë„ŒíŠ¸ |
| `.env.local` | êµ¬ê¸€ OAuth ì •ë³´ ì €ì¥ |

---

## ğŸ¦® 1. ì¸ì¦ ë¡œì§ì˜ ì‹¬ì¥

`route.ts` íŒŒì¼
```tsx
import NextAuth from 'next-auth';
import GoogleProvider from 'next-auth/providers/google';
import clientPromise from '@/lib/mongodb';
```

ì—¬ê¸°ì„  `NextAuth`ë¼ëŠ” í•¨ìˆ˜ë¥¼ ê°€ì ¸ì™€ì„œ êµ¬ê¸€ ë¡œê·¸ì¸ í”„ë¡œë°”ì´ë”ë¡œ ì„¤ì •í•´ìš”.

```ts
const handler = NextAuth({
  providers: [
    GoogleProvider({
      clientId: process.env.GOOGLE_CLIENT_ID || "",
      clientSecret: process.env.GOOGLE_CLIENT_SECRET || "",
    }),
  ],
```

- êµ¬ê¸€ ë¡œê·¸ì¸ í”„ë¡œë°”ì´ë”ë¥¼ ë“±ë¡í•©ë‹ˆë‹¤.
- `clientId`, `clientSecret`ì€ êµ¬ê¸€ OAuth ì½˜ì†”ì—ì„œ ë°›ì•„ì•¼ í•´ìš”.

---

### ğŸ¦„ ì„¸ì…˜ ì „ëµ: ì™œ `jwt`?

```ts
session: { strategy: "jwt" },
```

- ê¸°ë³¸ ì„¸ì…˜ì€ DBë¥¼ ì´ìš©í•˜ì§€ë§Œ, ìš°ë¦¬ëŠ” **DB ì—†ì´ë„ ì„¸ì…˜ì„ ìœ ì§€í•  ìˆ˜ ìˆëŠ” JWT ë°©ì‹**ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
- í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë²„ ê°„ ì¸ì¦ ìƒíƒœë¥¼ ê°„í¸í•˜ê²Œ ìœ ì§€ê°€ ê°€ëŠ¥í•˜ê¸° ë•Œë¬¸ì´ì£ .

---

### ğŸ¦„ ë¡œê·¸ì¸ ì„±ê³µ ì‹œ ì‚¬ìš©ì ì •ë³´ ì €ì¥

```ts
async signIn({ user }) {
  // DB ì—°ê²°
  const client = await clientPromise;
  const db = client.db('gemo');
  const users = db.collection('users');
```

- ë¡œê·¸ì¸ì„ ì‹œë„í•œ ì‚¬ìš©ìê°€ DBì— ì´ë¯¸ ìˆìœ¼ë©´? ğŸ‘‰ ê¸°ì¡´ ì‚¬ìš©ìë¡œ ë¡œê·¸ì¸
- ì—†ìœ¼ë©´? ğŸ‘‰ `gameData` í¬í•¨í•´ì„œ ìƒˆë¡œ ë§Œë“¤ì–´ì¤ë‹ˆë‹¤

```ts
const newUser = {
  name: user.name,
  email: user.email,
  image: user.image,
  gameData: {
    level: 1,
    currentXp: 0,
    totalScore: 0,
    kodleGameWins: 0,
    kodleGameDefeat: 0,
    kodleSuccessiveVictory: 0,
    kodleMaximumSuccessiveVictory: 0,
    achievements: [],
    lastPlayed: null,
    lastAttendance: null,
    consecutiveAttendance: 0,
  },
  thema: 'light',
  notifications: true,
};
```

> ì´ë ‡ê²Œ êµ¬ì¡°í™”í•´ì„œ ì‚¬ìš©ì ë°ì´í„°ë¥¼ ì»¤ìŠ¤í„°ë§ˆì´ì§•í•´ì„œ ì €ì¥í•©ë‹ˆë‹¤.

---

### ğŸ¦„ ì½œë°± ì„¤ëª…: jwt & session

```ts
callbacks: {
  async jwt({ token, user }) {
    if (user) token.userId = user.id;
    return token;
  },
  async session({ session, token }) {
    if (token?.userId && session.user) {
      (session.user as any).id = token.userId;
    }
    return session;
  },
}
```

- ë¡œê·¸ì¸ í›„ í† í°ì— `userId`ë¥¼ ë„£ê³ 
- ì´í›„ `getServerSession()` ê°™ì€ ê³³ì—ì„œ ì‰½ê²Œ êº¼ë‚´ì“¸ ìˆ˜ ìˆë„ë¡ `session.user.id`ì— ì„¤ì •í•´ì¤˜ìš”.

---

## ğŸ¦® 2. ë¡œê·¸ì¸ ë²„íŠ¼ UI

`Auth.tsx` íŒŒì¼
```tsx
"use client";

import { signIn, getProviders } from "next-auth/react";
```

- í´ë¼ì´ì–¸íŠ¸ ì»´í¬ë„ŒíŠ¸ë¡œ, ì‹¤ì œ ë¡œê·¸ì¸ ë²„íŠ¼ì„ ê·¸ë ¤ì¤ë‹ˆë‹¤.

```tsx
const [providers, setProviders] = useState(null);
useEffect(() => {
  getProviders().then(setProviders);
}, []);
```

- `getProviders()`ë¡œ ë¡œê·¸ì¸ ë°©ì‹(êµ¬ê¸€ ë“±)ì„ ë°›ì•„ì˜µë‹ˆë‹¤.

```tsx
<button onClick={() => signIn(provider.id)}>
  {provider.name}ë¡œ ë¡œê·¸ì¸
</button>
```

- ë²„íŠ¼ í´ë¦­í•˜ë©´ `signIn()` í˜¸ì¶œ â†’ êµ¬ê¸€ ë¡œê·¸ì¸ ì‹œì‘!

---

## ğŸ¦® 3. MongoDB ì—°ê²°

`mongodb.ts` íŒŒì¼
```ts
import { MongoClient } from "mongodb";

const uri = process.env.MONGODB_URI!;
const client = new MongoClient(uri);
let clientPromise = client.connect();

export default clientPromise;
```

ë§¤ ìš”ì²­ë§ˆë‹¤ ìƒˆ ì—°ê²°ì„ ë§Œë“¤ë©´ ë¹„íš¨ìœ¨ì ì´ë‹ˆê¹Œ  
`clientPromise`ë¡œ ì „ì—­ ì—°ê²°ì„ ì¬í™œìš©í•´ìš”!

---

## ğŸ¦® 4. APIì—ì„œ ì„¸ì…˜ í™•ì¸í•˜ëŠ” ë°©ë²•

```ts
import { getServerSession } from 'next-auth';
import { authOptions } from '@/app/api/auth/[...nextauth]/route';

const session = await getServerSession(authOptions);

if (!session?.user) {
  return Response.json({ error: 'ë¡œê·¸ì¸ í•´ì£¼ì„¸ìš”' }, { status: 401 });
}

const userId = session.user.id;
```

- `authOptions`ë¥¼ ê³µìœ í•´ì„œ APIì—ì„œë„ ë¡œê·¸ì¸ëœ ìœ ì € ì‹ë³„ì´ ê°€ëŠ¥!

---

## ğŸ¦® ìš”ì•½ ë° ë§ˆë¬´ë¦¬

| í•­ëª© | ì„¤ëª… |
|------|------|
| MongoDBAdapter ë¯¸ì‚¬ìš© | ì‚¬ìš©ì êµ¬ì¡° ì»¤ìŠ¤í„°ë§ˆì´ì§• í•„ìš”í•´ì„œ |
| ì„¸ì…˜ ì „ëµ | JWTë¡œ ì„¤ì •í•´ì„œ ì„œë²„ì— ë¶€ë‹´ X |
| ì‚¬ìš©ì ì €ì¥ | ì§ì ‘ MongoDB ì—°ê²°í•´ì„œ `users` ì»¬ë ‰ì…˜ì— ì‚½ì… |
| UI êµ¬ì„± | `getProviders()`ë¡œ OAuth ëª©ë¡ ë°›ì•„ì„œ ë²„íŠ¼ ë Œë”ë§ |
| ì‚¬ìš©ì ì‹ë³„ | `session.user.id`ë¡œ APIì—ì„œ ì‰½ê²Œ ì¶”ì¶œ ê°€ëŠ¥ |

êµ¬ê¸€ ë¡œê·¸ì¸ì„ êµ¬í˜„í•  ë•Œ, ì™œ `MongoDBAdapter`ë¥¼ êµ³ì´ ì•ˆ ì¨ë„ ë˜ê³ 
`NextAuth` ì½œë°±ê³¼ `MongoDB` í´ë¼ì´ì–¸íŠ¸ë¥¼ ì˜ ì¡°í•©í•˜ë©´ **ì™„ì „ ì»¤ìŠ¤í„°ë§ˆì´ì§•ëœ ì¸ì¦ ì‹œìŠ¤í…œ**ì„ êµ¬ì¶•í•  ìˆ˜ ìˆì–´ìš”.